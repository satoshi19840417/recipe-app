<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„É¨„Ç∑„Éî„Çø„Ç§„Éû„Éº - ÁÆ°ÁêÜ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tint: #FF6B35;
            --background: #FFFFFF;
            --card: #FFFFFF;
            --text: #000000;
            --secondary: #666666;
            --border: rgba(0, 0, 0, 0.1);
            --shadow: rgba(0, 0, 0, 0.1);
            --danger: #FF3B30;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --tint: #FF6B35;
                --background: #151718;
                --card: #232526;
                --text: #ECEDEE;
                --secondary: #9BA1A6;
                --border: rgba(255, 255, 255, 0.1);
                --shadow: rgba(0, 0, 0, 0.3);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans JP', sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.5;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            background-color: var(--background);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            height: 56px;
        }

        .header-title {
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--tint);
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Content */
        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Views */
        .view {
            display: none;
            padding: 16px;
        }

        .view.active {
            display: block;
        }

        /* Recipe List */
        .recipe-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recipe-card {
            background-color: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .recipe-card:active {
            opacity: 0.7;
        }

        .recipe-card-content {
            flex: 1;
        }

        .recipe-card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .recipe-card-meta {
            font-size: 13px;
            color: var(--secondary);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--secondary);
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background-color: var(--tint);
            color: white;
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px var(--shadow);
            cursor: pointer;
            z-index: 200;
            border: none;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 16px;
            background-color: var(--card);
            color: var(--text);
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--tint);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            margin-top: 24px;
        }

        .add-btn {
            font-size: 14px;
            color: var(--tint);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .list-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .delete-btn {
            color: var(--secondary);
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
        }

        .delete-btn:hover {
            color: var(--danger);
        }

        /* Shared Styles (from original) */
        .badge {
            background-color: var(--tint);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .timer-btn {
            background-color: var(--tint);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            gap: 8px;
            font-size: 14px;
            margin-top: 8px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: opacity 0.2s;
            display: block;
            width: 100%;
            margin-top: 8px;
        }

        .btn-primary {
            background-color: var(--tint);
            color: white;
        }

        .btn-secondary {
            background-color: var(--background);
            color: var(--text);
            border: 1px solid var(--border);
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .gap-2 {
            gap: 8px;
        }

        .w-full {
            width: 100%;
        }

        .mt-4 {
            margin-top: 16px;
        }
    </style>
</head>

<body>
    <div id="app" class="container">
        <!-- Header -->
        <header class="header">
            <button id="back-btn" class="header-btn hidden">Ôºú Êàª„Çã</button>
            <h1 id="header-title" class="header-title">„É¨„Ç∑„Éî„Çø„Ç§„Éû„Éº</h1>
            <div style="width: 48px"></div> <!-- Spacer -->
        </header>

        <!-- View: Recipe List (Home) -->
        <div id="view-list" class="view">
            <div
                style="margin-bottom: 16px; position: sticky; top: 56px; z-index: 90; background: var(--background); padding-top: 4px; padding-bottom: 4px;">
                <input type="search" id="search-input" class="form-input" placeholder="„É¨„Ç∑„ÉîÂêç„ÉªÊùêÊñôÂêç„ÅßÊ§úÁ¥¢..."
                    style="border-radius: 50px; padding-left: 20px;">
            </div>
            <div id="recipe-list-container" class="recipe-list">
                <!-- Recipes injected here -->
            </div>
            <div id="empty-state" class="empty-state hidden">
                <div style="font-size: 48px; margin-bottom: 16px">üç≥</div>
                <h3 id="empty-title">„É¨„Ç∑„Éî„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h3>
                <p id="empty-desc">Âè≥‰∏ã„ÅÆ„Éú„Çø„É≥„Åã„ÇâÊñ∞„Åó„ÅÑ„É¨„Ç∑„Éî„Çí‰ΩúÊàê„Åô„Çã„Åã„ÄÅ<br>„Ç¢„Éó„É™„Åã„ÇâÂÖ±Êúâ„Åï„Çå„Åü„É¨„Ç∑„Éî„Çí‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            </div>

            <button id="fab-create" class="fab">+</button>
        </div>

        <!-- View: Recipe Create/Edit Form -->
        <div id="view-form" class="view">
            <div class="form-group">
                <label class="form-label">„É¨„Ç∑„ÉîÂêç</label>
                <input type="text" id="form-name" class="form-input" placeholder="‰æã: „Ç´„É¨„Éº„É©„Ç§„Çπ">
            </div>

            <div class="section-header">
                <label class="form-label" style="margin:0">ÊùêÊñô</label>
                <button type="button" class="add-btn" onclick="addIngredientInput()">+ ËøΩÂä†</button>
            </div>
            <div id="form-ingredients">
                <!-- Ingredient inputs -->
            </div>

            <div class="section-header">
                <label class="form-label" style="margin:0">‰Ωú„ÇäÊñπ„ÉªÂ∑•Á®ã</label>
                <button type="button" class="add-btn" onclick="addStepInput()">+ ËøΩÂä†</button>
            </div>
            <div id="form-steps">
                <!-- Step inputs -->
            </div>

            <div class="mt-4 flex gap-2">
                <button id="form-cancel" class="action-btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="form-save" class="action-btn btn-primary">‰øùÂ≠ò„Åô„Çã</button>
            </div>
        </div>

        <!-- View: Recipe Detail (Shared/Preview) -->
        <div id="view-detail" class="view">
            <!-- Cooking Time -->
            <div id="cooking-time-section" class="cooking-time-card hidden"
                style="margin-bottom: 16px; padding: 16px; background: var(--card); border-radius: 12px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border);">
                <span style="font-size: 24px">‚è±Ô∏è</span>
                <div>
                    <div style="font-size: 12px; color: var(--secondary)">Á∑èË™øÁêÜÊôÇÈñì</div>
                    <div id="total-time" style="font-size: 18px; font-weight: 600; color: var(--tint)">--ÂàÜ</div>
                </div>
            </div>

            <h2 id="detail-subtitle-ing" style="font-size: 18px; font-weight: 700; margin-bottom: 8px">ÊùêÊñô <span
                    id="ingredient-badge" class="badge">0</span></h2>
            <div id="detail-ingredients"
                style="background: var(--card); border-radius: 12px; padding: 0 16px; border: 1px solid var(--border); margin-bottom: 24px">
                <!-- Using existing styles mainly -->
            </div>

            <h2 id="detail-subtitle-steps" style="font-size: 18px; font-weight: 700; margin-bottom: 8px">‰Ωú„ÇäÊñπ</h2>
            <div id="detail-steps">
                <!-- Steps -->
            </div>

            <div class="mt-4">
                <button id="save-shared-btn" class="action-btn btn-primary hidden">„Åì„ÅÆ„É¨„Ç∑„Éî„Çí‰øùÂ≠ò</button>
                <button id="edit-local-btn" class="action-btn btn-secondary hidden">„É¨„Ç∑„Éî„ÇíÁ∑®ÈõÜ</button>
                <a id="open-app-btn" href="#" class="action-btn btn-secondary hidden"
                    style="display:flex; justify-content:center; align-items:center;">„Ç¢„Éó„É™„ÅßÈñã„Åè</a>
            </div>
        </div>
    </div>

    <script>
        // --- State & Utils ---
        const LS_KEY = 'recipeTimer_recipes';

        function getStoredRecipes() {
            try {
                return JSON.parse(localStorage.getItem(LS_KEY) || '[]');
            } catch {
                return [];
            }
        }

        function saveStoredRecipes(recipes) {
            localStorage.setItem(LS_KEY, JSON.stringify(recipes));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // --- Router ---
        function navigate() {
            const hash = window.location.hash;
            const headerTitle = document.getElementById('header-title');
            const backBtn = document.getElementById('back-btn');

            // Components
            const viewList = document.getElementById('view-list');
            const viewForm = document.getElementById('view-form');
            const viewDetail = document.getElementById('view-detail');

            // Hide all
            [viewList, viewForm, viewDetail].forEach(el => el.classList.remove('active'));
            backBtn.classList.add('hidden');

            if (!hash || hash === '#') {
                // List View
                viewList.classList.add('active');
                headerTitle.textContent = '„É¨„Ç∑„Éî‰∏ÄË¶ß';
                renderList();
            }
            else if (hash === '#create') {
                viewForm.classList.add('active');
                headerTitle.textContent = 'Êñ∞Ë¶è„É¨„Ç∑„Éî';
                backBtn.classList.remove('hidden');
                backBtn.onclick = () => window.history.back();
                initForm();
            }
            else if (hash.startsWith('#edit/')) {
                // Edit View
                const id = hash.substring(6);
                const recipes = getStoredRecipes();
                const recipe = recipes.find(r => r.id === id);
                if (recipe) {
                    viewForm.classList.add('active');
                    headerTitle.textContent = '„É¨„Ç∑„ÉîÁ∑®ÈõÜ';
                    backBtn.classList.remove('hidden');
                    backBtn.onclick = () => window.history.back();
                    initForm(recipe);
                } else {
                    window.location.hash = '';
                }
            }
            else if (hash.startsWith('#data=')) {
                // Shared View
                viewDetail.classList.add('active');
                const data = getRecipeDataFromHash(hash);
                if (data) {
                    const recipe = Array.isArray(data) ? data[0] : data;
                    headerTitle.textContent = recipe.n || recipe.name || 'ÂÖ±Êúâ„É¨„Ç∑„Éî';
                    renderDetail(recipe, true); // true = isShared
                } else {
                    alert('„É¨„Ç∑„Éî„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                backBtn.classList.remove('hidden');
                backBtn.onclick = () => window.location.hash = '';
            }
            else if (hash.startsWith('#view/')) {
                // Local Detail View
                const id = hash.substring(6);
                const recipes = getStoredRecipes();
                const recipe = recipes.find(r => r.id === id);
                if (recipe) {
                    viewDetail.classList.add('active');
                    headerTitle.textContent = recipe.name;
                    renderDetail(recipe, false);
                    backBtn.classList.remove('hidden');
                    backBtn.onclick = () => window.location.hash = '';
                } else {
                    window.location.hash = '';
                }
            }
        }

        function getRecipeDataFromHash(hash) {
            if (!hash.startsWith('#data=')) return null;
            try {
                const encoded = hash.substring(6);
                const base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
                const padded = base64 + "=".repeat((4 - (base64.length % 4)) % 4);
                const decoded = decodeURIComponent(atob(padded));
                return JSON.parse(decoded);
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        // --- Render: List ---
        function renderList(query = '') {
            let recipes = getStoredRecipes();
            const container = document.getElementById('recipe-list-container');
            const emptyState = document.getElementById('empty-state');
            const emptyTitle = document.getElementById('empty-title');
            const emptyDesc = document.getElementById('empty-desc');

            // Filter
            if (query) {
                const q = query.toLowerCase();
                recipes = recipes.filter(r => {
                    const nameMatch = (r.name || '').toLowerCase().includes(q);
                    const ingMatch = (r.ingredients || []).some(i => (i.name || '').toLowerCase().includes(q));
                    return nameMatch || ingMatch;
                });
            }

            container.innerHTML = '';

            if (recipes.length === 0) {
                emptyState.classList.remove('hidden');
                if (query) {
                    emptyTitle.textContent = 'Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü';
                    emptyDesc.textContent = `"${query}" „Å´‰∏ÄËá¥„Åô„Çã„É¨„Ç∑„Éî„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì`;
                } else {
                    emptyTitle.textContent = '„É¨„Ç∑„Éî„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    emptyDesc.innerHTML = 'Âè≥‰∏ã„ÅÆ„Éú„Çø„É≥„Åã„ÇâÊñ∞„Åó„ÅÑ„É¨„Ç∑„Éî„Çí‰ΩúÊàê„Åô„Çã„Åã„ÄÅ<br>„Ç¢„Éó„É™„Åã„ÇâÂÖ±Êúâ„Åï„Çå„Åü„É¨„Ç∑„Éî„Çí‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                }
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            recipes.forEach(recipe => {
                const el = document.createElement('div');
                el.className = 'recipe-card';
                el.onclick = () => window.location.hash = `#view/${recipe.id}`;

                // Calculate time
                const totalSeconds = (recipe.steps || []).reduce((acc, s) => acc + (s.duration || 0), 0);
                const timeText = totalSeconds > 0 ? `${Math.floor(totalSeconds / 60)}ÂàÜ` : '- ÂàÜ';

                el.innerHTML = `
                    <div style="font-size: 32px">üç≥</div>
                    <div class="recipe-card-content">
                        <div class="recipe-card-title">${escapeHtml(recipe.name)}</div>
                        <div class="recipe-card-meta">
                            ‚è± ${timeText} ¬∑ üìù ÊùêÊñô ${recipe.ingredients?.length || 0} ¬∑ üî® Â∑•Á®ã ${recipe.steps?.length || 0}
                        </div>
                    </div>
                    <button class="delete-btn" style="font-size:18px" onclick="event.stopPropagation(); deleteRecipe('${recipe.id}')">üóë</button>
                    <div style="color: var(--secondary)">‚Ä∫</div>
                `;
                container.appendChild(el);
            });
        }

        function deleteRecipe(id) {
            if (!confirm('„Åì„ÅÆ„É¨„Ç∑„Éî„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            const recipes = getStoredRecipes().filter(r => r.id !== id);
            saveStoredRecipes(recipes);
            renderList();
        }

        // --- Render: Detail ---
        function renderDetail(recipe, isShared) {
            // Updated normalized props
            const ingredients = recipe.i || recipe.ingredients || [];
            const steps = recipe.s || recipe.steps || [];

            // Ingredients
            const ingList = document.getElementById('detail-ingredients');
            document.getElementById('ingredient-badge').textContent = `${ingredients.length}`;
            ingList.innerHTML = ingredients.map(ing => `
                <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border)">
                    <span>${escapeHtml(ing.n || ing.name)}</span>
                    <span style="color:var(--secondary)">${escapeHtml(ing.a || ing.amount)}</span>
                </div>
            `).join('');
            // Remove last border
            if (ingList.lastElementChild) ingList.lastElementChild.style.borderBottom = 'none';

            // Steps
            const stepsList = document.getElementById('detail-steps');
            let totalSeconds = 0;
            stepsList.innerHTML = steps.map((step, i) => {
                const duration = step.t || step.duration || 0;
                totalSeconds += duration;

                let timerHtml = '';
                if (duration > 0) {
                    const min = Math.floor(duration / 60);
                    const sec = duration % 60;
                    const timeText = sec > 0 ? `${min}ÂàÜ${sec}Áßí` : `${min}ÂàÜ`;
                    timerHtml = `<button class="timer-btn">‚è± ${timeText}</button>`;
                }

                return `
                    <div style="background:var(--card); padding:16px; border-radius:12px; border:1px solid var(--border); margin-bottom:12px">
                        <div style="display:flex; gap:12px;">
                            <div style="width:24px; height:24px; background:var(--tint); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; flex-shrink:0">${i + 1}</div>
                            <div style="flex:1; line-height:1.6">${escapeHtml(step.d || step.description)}</div>
                        </div>
                        ${timerHtml}
                    </div>
                `;
            }).join('');

            // Total Time
            if (totalSeconds > 0) {
                const tMin = Math.floor(totalSeconds / 60);
                document.getElementById('cooking-time-section').classList.remove('hidden');
                document.getElementById('total-time').textContent = `Á¥Ñ${tMin}ÂàÜ`;
            } else {
                document.getElementById('cooking-time-section').classList.add('hidden');
            }

            // Buttons
            const saveBtn = document.getElementById('save-shared-btn');
            const openAppBtn = document.getElementById('open-app-btn');
            const editBtn = document.getElementById('edit-local-btn'); // New

            if (isShared) {
                saveBtn.classList.remove('hidden');
                openAppBtn.classList.remove('hidden');
                if (editBtn) editBtn.classList.add('hidden');

                // Save logic
                saveBtn.onclick = () => {
                    const newRecipe = {
                        id: generateId(),
                        name: recipe.n || recipe.name || 'ÂêçÁß∞Êú™Ë®≠ÂÆö',
                        ingredients: ingredients.map(i => ({ name: i.n || i.name, amount: i.a || i.amount })),
                        steps: steps.map(s => ({ description: s.d || s.description, duration: s.t || s.duration || 0 })),
                        createdAt: new Date().toISOString()
                    };
                    const stored = getStoredRecipes();
                    stored.unshift(newRecipe);
                    saveStoredRecipes(stored);
                    alert('„É¨„Ç∑„Éî„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                    window.location.hash = ''; // Go to list
                };

                // Deep link
                const hash = window.location.hash;
                const encodedData = hash.substring(6);
                openAppBtn.href = `recipetimer://sync?data=${encodedData}`;

                openAppBtn.href = `recipetimer://sync?data=${encodedData}`;

            } else {
                saveBtn.classList.add('hidden');
                openAppBtn.classList.add('hidden');
                if (editBtn) {
                    editBtn.classList.remove('hidden');
                    editBtn.onclick = () => window.location.hash = `#edit/${recipe.id}`;
                }
            }
        }

        // --- Form Logic ---
        let editingId = null; // Track editing state

        function initForm(recipe = null) {
            editingId = recipe ? recipe.id : null;
            document.getElementById('form-name').value = recipe ? recipe.name : '';
            document.getElementById('form-ingredients').innerHTML = '';
            document.getElementById('form-steps').innerHTML = '';

            if (recipe) {
                // Load Ingredients
                (recipe.ingredients || []).forEach(ing => addIngredientInput(ing.name, ing.amount));
                // Load Steps
                (recipe.steps || []).forEach(step => addStepInput(step.description, step.duration));
            } else {
                // Add initial empty fields
                addIngredientInput();
                addStepInput();
            }
        }

        function addIngredientInput(name = '', amount = '') {
            const container = document.getElementById('form-ingredients');
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <input type="text" class="form-input" style="flex:2" placeholder="ÊùêÊñôÂêç (‰æã: Ë±öËÇâ)" value="${escapeHtml(name)}">
                <input type="text" class="form-input" style="flex:1" placeholder="ÂàÜÈáè" value="${escapeHtml(amount)}">
                <button type="button" class="delete-btn" onclick="this.parentElement.remove()">üóë</button>
            `;
            container.appendChild(div);
        }

        function addStepInput(desc = '', duration = 0) {
            const min = Math.floor(duration / 60);
            const sec = duration % 60;
            const container = document.getElementById('form-steps');
            const div = document.createElement('div');
            div.className = 'list-item';
            div.style.alignItems = 'flex-start';
            div.innerHTML = `
                <div style="flex:1; display:flex; flex-direction:column; gap:8px">
                    <textarea class="form-input" rows="2" placeholder="Â∑•Á®ã„ÅÆË™¨Êòé">${escapeHtml(desc)}</textarea>
                    <div style="display:flex; align-items:center; gap:8px; font-size:14px">
                        ‚è± „Çø„Ç§„Éû„Éº: <input type="number" class="form-input" style="width:80px" placeholder="ÂàÜ" min="0" value="${min || ''}"> ÂàÜ
                        <input type="number" class="form-input" style="width:80px" placeholder="Áßí" min="0" max="59" value="${sec || ''}"> Áßí
                    </div>
                </div>
                <button type="button" class="delete-btn" onclick="this.parentElement.remove()">üóë</button>
            `;
            container.appendChild(div);
        }

        document.getElementById('form-save').onclick = () => {
            const name = document.getElementById('form-name').value.trim();
            if (!name) {
                alert('„É¨„Ç∑„ÉîÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // Collect Ingredients
            const ingEls = document.querySelectorAll('#form-ingredients .list-item');
            const ingredients = Array.from(ingEls).map(el => {
                const inputs = el.querySelectorAll('input');
                return {
                    name: inputs[0].value.trim(),
                    amount: inputs[1].value.trim()
                };
            }).filter(i => i.name); // Filter empty names

            // Collect Steps
            const stepEls = document.querySelectorAll('#form-steps .list-item');
            const steps = Array.from(stepEls).map(el => {
                const desc = el.querySelector('textarea').value.trim();
                const inputs = el.querySelectorAll('input[type="number"]');
                const min = parseInt(inputs[0].value) || 0;
                const sec = parseInt(inputs[1].value) || 0;

                if (!desc) return null;

                return {
                    description: desc,
                    duration: (min * 60) + sec
                };
            }).filter(s => s); // Filter empty descriptions

            if (steps.length === 0) {
                if (!confirm('Ë™øÁêÜÂ∑•Á®ã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åå‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü')) return;
            }

            const stored = getStoredRecipes();

            if (editingId) {
                // Update existing
                const index = stored.findIndex(r => r.id === editingId);
                if (index !== -1) {
                    stored[index] = {
                        ...stored[index],
                        name: name,
                        ingredients: ingredients,
                        steps: steps,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // Create new
                const newRecipe = {
                    id: generateId(),
                    name: name,
                    ingredients: ingredients,
                    steps: steps,
                    createdAt: new Date().toISOString()
                };
                stored.unshift(newRecipe);
            }

            saveStoredRecipes(stored);

            window.location.hash = ''; // Return to list
        };

        document.getElementById('form-cancel').onclick = () => {
            window.history.back();
        };

        document.getElementById('fab-create').onclick = () => {
            window.location.hash = '#create';
        };

        document.getElementById('search-input').addEventListener('input', (e) => {
            renderList(e.target.value.trim());
        });

        // --- Init ---
        window.addEventListener('hashchange', navigate);
        window.addEventListener('DOMContentLoaded', navigate);

    </script>
</body>

</html>