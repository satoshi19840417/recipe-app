<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„É¨„Ç∑„Éî„Çø„Ç§„Éû„ÅE - ÁÆ°ÁêÅE/title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --tint: #FF6B35;
            --background: #FFFFFF;
            --card: #FFFFFF;
            --text: #000000;
            --secondary: #666666;
            --border: rgba(0, 0, 0, 0.1);
            --shadow: rgba(0, 0, 0, 0.1);
            --danger: #FF3B30;
            --success: #34C759;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --tint: #FF6B35;
                --background: #151718;
                --card: #232526;
                --text: #ECEDEE;
                --secondary: #9BA1A6;
                --border: rgba(255, 255, 255, 0.1);
                --shadow: rgba(0, 0, 0, 0.3);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans JP', sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.5;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            background-color: var(--background);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            height: 56px;
        }

        .header-title {
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--tint);
            background: none;
            border: none;
            cursor: pointer;
        }

        .header-icon-btn {
            padding: 8px;
            font-size: 20px;
            background: none;
            border: none;
            cursor: pointer;
            min-width: 48px;
            text-align: center;
        }

        /* Content */
        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Views */
        .view {
            display: none;
            padding: 16px;
        }

        .view.active {
            display: block;
        }

        /* Recipe List */
        .recipe-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recipe-card {
            background-color: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .recipe-card:active {
            opacity: 0.7;
        }

        .recipe-card-content {
            flex: 1;
        }

        .recipe-card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .recipe-card-meta {
            font-size: 13px;
            color: var(--secondary);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--secondary);
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background-color: var(--tint);
            color: white;
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px var(--shadow);
            cursor: pointer;
            z-index: 200;
            border: none;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 16px;
            background-color: var(--card);
            color: var(--text);
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--tint);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            margin-top: 24px;
        }

        .add-btn {
            font-size: 14px;
            color: var(--tint);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .list-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .delete-btn {
            color: var(--secondary);
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
        }

        .delete-btn:hover {
            color: var(--danger);
        }

        /* Shared Styles (from original) */
        .badge {
            background-color: var(--tint);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .timer-btn {
            background-color: var(--tint);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            gap: 8px;
            font-size: 14px;
            margin-top: 8px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: opacity 0.2s;
            display: block;
            width: 100%;
            margin-top: 8px;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--tint);
            color: white;
        }

        .btn-secondary {
            background-color: var(--background);
            color: var(--text);
            border: 1px solid var(--border);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            background: var(--card);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            border: none;
            background: transparent;
            color: var(--secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--tint);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* AI Import */
        .ai-upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 32px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--card);
        }

        .ai-upload-area:hover {
            border-color: var(--tint);
            background: rgba(255, 107, 53, 0.05);
        }

        .ai-upload-area.dragover {
            border-color: var(--tint);
            background: rgba(255, 107, 53, 0.1);
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 16px;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--tint);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: white;
            margin-top: 16px;
            font-size: 16px;
        }

        /* Settings */
        .setting-item {
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 16px;
            margin-bottom: 12px;
        }

        .setting-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        .setting-description {
            font-size: 13px;
            color: var(--secondary);
            margin-top: 8px;
        }

        .api-key-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.success {
            background: var(--success);
        }

        .status-dot.error {
            background: var(--danger);
        }

        /* Login */
        .login-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }

        .login-logo {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--secondary);
            margin-bottom: 32px;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 14px 24px;
            background: white;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 250px;
        }

        .google-btn:hover {
            background: #f5f5f5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .google-btn img {
            width: 20px;
            height: 20px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .gap-2 {
            gap: 8px;
        }

        .w-full {
            width: 100%;
        }

        .mt-4 {
            margin-top: 16px;
        }
    </style>
</head>

<body>
    <!-- Login View -->
    <div id="view-login" class="login-container">
        <div class="login-logo">üç≥</div>
        <h1 class="login-title">„É¨„Ç∑„Éî„Çø„Ç§„Éû„ÅE</h1>
        <p class="login-subtitle">„É≠„Ç∞„Ç§„É≥„Åó„Å¶„É¨„Ç∑„Éî„ÇíÁÆ°ÁêÅEÅó„Åæ„Åó„Çá„ÅÅE/p>
        <button id="google-login-btn" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
            Google„Åß„É≠„Ç∞„Ç§„É≥
        </button>
        <p id="login-error" class="setting-description hidden" style="color: var(--danger); margin-top: 16px;"></p>
    </div>

    <div id="app" class="container hidden">
        <!-- Header -->
        <header class="header">
            <button id="back-btn" class="header-btn hidden">ÅEÅEÊàª„ÇÅE/button>
            <h1 id="header-title" class="header-title">„É¨„Ç∑„Éî„Çø„Ç§„Éû„ÅE</h1>
            <div id="user-menu" class="user-info hidden">
                <img id="user-avatar" class="user-avatar" src="" alt="">
                <button id="logout-btn" class="header-btn" style="padding: 4px 8px; font-size: 12px;">„É≠„Ç∞„Ç¢„Ç¶„ÉÅE/button>
            </div>
            <button id="settings-btn" class="header-icon-btn">‚öôÔ∏ÅE/button>
        </header>

        <!-- View: Recipe List (Home) -->
        <div id="view-list" class="view">
            <div
                style="margin-bottom: 16px; position: sticky; top: 56px; z-index: 90; background: var(--background); padding-top: 4px; padding-bottom: 4px;">
                <input type="search" id="search-input" class="form-input" placeholder="„É¨„Ç∑„ÉîÂêç„ÉªÊùêÊñôÂêç„ÅßÊ§úÁ¥¢..."
                    style="border-radius: 50px; padding-left: 20px;">
            </div>
            <div id="recipe-list-container" class="recipe-list">
                <!-- Recipes injected here -->
            </div>
            <div id="empty-state" class="empty-state hidden">
                <div style="font-size: 48px; margin-bottom: 16px">üç≥</div>
                <h3 id="empty-title">„É¨„Ç∑„Éî„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h3>
                <p id="empty-desc">Âè≥‰∏ã„ÅE„Éú„Çø„É≥„Åã„ÇâÊñ∞„Åó„ÅÑ„É¨„Ç∑„Éî„Çí‰ΩúÊÅE„Åô„Çã„Åã„ÄÅEbr>„Ç¢„Éó„É™„Åã„ÇâÂÖ±Êúâ„Åï„Çå„Åü„É¨„Ç∑„Éî„Çí‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE/p>
            </div>

            <button id="fab-create" class="fab">+</button>
        </div>

        <!-- View: Recipe Create/Edit Form -->
        <div id="view-form" class="view">
            <!-- Tabs for input method -->
            <div class="tabs">
                <button class="tab active" data-tab="manual">‚úèÔ∏ÅEÊâãÂÅEÂäÅE/button>
                <button class="tab" data-tab="image">üì∑ ÁîªÂÉè„Åã„ÇÅE/button>
                <button class="tab" data-tab="url">üîó URL„Åã„Çâ</button>
            </div>

            <!-- Tab: Manual Input -->
            <div id="tab-manual" class="tab-content active">
                <div class="form-group">
                    <label class="form-label">„É¨„Ç∑„ÉîÂêç</label>
                    <input type="text" id="form-name" class="form-input" placeholder="‰æÅE „Ç´„É¨„Éº„É©„Ç§„Çπ">
                </div>

                <div class="section-header">
                    <label class="form-label" style="margin:0">ÊùêÊñô</label>
                    <button type="button" class="add-btn" onclick="addIngredientInput()">+ ËøΩÂä†</button>
                </div>
                <div id="form-ingredients">
                    <!-- Ingredient inputs -->
                </div>

                <div class="section-header">
                    <label class="form-label" style="margin:0">‰Ωú„ÇäÊñπ„ÉªÂ∑•Á®ÅE/label>
                    <button type="button" class="add-btn" onclick="addStepInput()">+ ËøΩÂä†</button>
                </div>
                <div id="form-steps">
                    <!-- Step inputs -->
                </div>

                <div class="mt-4 flex gap-2">
                    <button id="form-cancel" class="action-btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
                    <button id="form-save" class="action-btn btn-primary">‰øùÂ≠ò„Åô„ÇÅE/button>
                </div>
            </div>

            <!-- Tab: Image Import -->
            <div id="tab-image" class="tab-content">
                <div class="ai-upload-area" id="image-upload-area">
                    <div style="font-size: 48px; margin-bottom: 12px">üì∑</div>
                    <p style="font-weight: 600; margin-bottom: 8px">ÁîªÂÉè„Çí„Ç¢„ÉÅEÅE„É≠„Éº„ÉÅE/p>
                    <p style="font-size: 14px; color: var(--secondary)">„ÇØ„É™„ÉÅEÇØ„Åó„Å¶ÈÅ∏Êäû„ÄÅ„Åæ„Åü„ÅE„Éâ„É©„ÉÅEÇ∞ÅEÅEÉâ„É≠„ÉÅEÅE</p>
                    <input type="file" id="image-file-input" accept="image/*" style="display: none">
                </div>
                <img id="image-preview" class="preview-image hidden" alt="„Éó„É¨„Éì„É•„Éº">

                <div class="mt-4" style="text-align: center">
                    <p style="font-size: 13px; color: var(--secondary); margin-bottom: 8px">„Åæ„Åü„ÅE</p>
                    <label class="action-btn btn-secondary"
                        style="display: inline-block; width: auto; padding: 12px 24px;">
                        üì∏ „Ç´„É°„É©„ÅßÊíÆÂΩ±
                        <input type="file" id="camera-input" accept="image/*" capture="environment"
                            style="display: none">
                    </label>
                </div>

                <div class="mt-4">
                    <button id="analyze-image-btn" class="action-btn btn-primary" disabled>
                        üîç AI„ÅßËß£Êûê„Åô„ÇÅE
                    </button>
                </div>
                <p id="image-api-warning" class="setting-description hidden"
                    style="color: var(--danger); text-align: center;">
                    ‚ö†ÅEÅEAPI„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÅEÅæ„Åõ„Çì„ÄÇË®≠ÂÆöÁîªÈù¢„ÅßAPI„Ç≠„Éº„ÇíÂÅEÂäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE
                </p>
            </div>

            <!-- Tab: URL Import -->
            <div id="tab-url" class="tab-content">
                <div class="form-group">
                    <label class="form-label">„É¨„Ç∑„ÉîURL</label>
                    <input type="url" id="url-input" class="form-input" placeholder="https://example.com/recipe/...">
                    <p class="setting-description">„ÇØ„ÉÅEÇØ„Éë„ÉÉ„Éâ„ÄÅÊ•ΩÂ§©„É¨„Ç∑„Éî„Å™„Å©„ÅÆURL„ÇíÂÅEÂäõ„Åô„Çã„Å®„ÄÅAI„Åå„É¨„Ç∑„Éî„ÇíÊé®Ê∏¨„Åó„Åæ„Åô„ÄÅE/p>
                </div>

                <div class="mt-4">
                    <button id="analyze-url-btn" class="action-btn btn-primary" disabled>
                        üîç URL„Åã„ÇâÂèñ„ÇäËæº„ÇÄ
                    </button>
                </div>
                <p id="url-api-warning" class="setting-description hidden"
                    style="color: var(--danger); text-align: center;">
                    ‚ö†ÅEÅEAPI„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÅEÅæ„Åõ„Çì„ÄÇË®≠ÂÆöÁîªÈù¢„ÅßAPI„Ç≠„Éº„ÇíÂÅEÂäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE
                </p>
            </div>
        </div>

        <!-- View: Recipe Detail (Shared/Preview) -->
        <div id="view-detail" class="view">
            <!-- Cooking Time -->
            <div id="cooking-time-section" class="cooking-time-card hidden"
                style="margin-bottom: 16px; padding: 16px; background: var(--card); border-radius: 12px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border);">
                <span style="font-size: 24px">‚è±ÅEÅE/span>
                <div>
                    <div style="font-size: 12px; color: var(--secondary)">Á∑èË™øÁêÅEôÇÈñÅE/div>
                    <div id="total-time" style="font-size: 18px; font-weight: 600; color: var(--tint)">--ÂàÅE/div>
                </div>
            </div>

            <h2 id="detail-subtitle-ing" style="font-size: 18px; font-weight: 700; margin-bottom: 8px">ÊùêÊñô <span
                    id="ingredient-badge" class="badge">0</span></h2>
            <div id="detail-ingredients"
                style="background: var(--card); border-radius: 12px; padding: 0 16px; border: 1px solid var(--border); margin-bottom: 24px">
                <!-- Using existing styles mainly -->
            </div>

            <h2 id="detail-subtitle-steps" style="font-size: 18px; font-weight: 700; margin-bottom: 8px">‰Ωú„ÇäÊñπ</h2>
            <div id="detail-steps">
                <!-- Steps -->
            </div>

            <div class="mt-4">
                <button id="save-shared-btn" class="action-btn btn-primary hidden">„Åì„ÅE„É¨„Ç∑„Éî„Çí‰øùÂ≠ÅE/button>
                <button id="edit-local-btn" class="action-btn btn-secondary hidden">„É¨„Ç∑„Éî„ÇíÁ∑®ÈõÅE/button>
                <a id="open-app-btn" href="#" class="action-btn btn-secondary hidden"
                    style="display:flex; justify-content:center; align-items:center;">„Ç¢„Éó„É™„ÅßÈñã„Åè</a>
            </div>
        </div>

        <!-- View: Settings -->
        <div id="view-settings" class="view">
            <div class="setting-item">
                <label class="setting-label">Gemini API „Ç≠„Éº</label>
                <input type="password" id="api-key-input" class="form-input" placeholder="AIzaSy...">
                <div id="api-key-status" class="api-key-status hidden">
                    <span class="status-dot success"></span>
                    <span>API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÅEÅæ„ÅÅE/span>
                </div>
                <p class="setting-description">
                    Google AI Studio„ÅßAPI„Ç≠„Éº„ÇíÂèñÂæó„Åß„Åç„Åæ„Åô„ÄÅEbr>
                    <a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--tint)">
                        üëâ API„Ç≠„Éº„ÇíÂèñÂæó„Åô„ÇÅE
                    </a>
                </p>
            </div>

            <div class="flex gap-2">
                <button id="save-api-key-btn" class="action-btn btn-primary" onclick="handleSaveApiKey()">‰øùÂ≠ÅE/button>
                <button id="clear-api-key-btn" class="action-btn btn-secondary"
                    onclick="handleClearApiKey()">„ÇØ„É™„Ç¢</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p id="loading-text" class="loading-text">Ëß£Êûê‰∏≠...</p>
    </div>

    <script>
        // --- Constants ---
        const LS_KEY = 'recipeTimer_recipes';
        const LS_API_KEY = 'recipeTimer_geminiApiKey';
        const GEMINI_API_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        // --- Supabase Config ---
        const SUPABASE_URL = 'https://ylyswgfmopidmecwapol.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_gMrVdqffW7enRZl00S8lzg_X6JAx4wC';

        let supabase = null;
        let currentUser = null;

        // --- State ---
        let editingId = null;
        let selectedImageBase64 = null;
        let selectedImageMimeType = null;

        // --- Supabase Auth ---
        function initSupabase() {
            if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                return true;
            }
            return false;
        }

        async function checkAuthState() {
            if (!supabase) return null;
            try {
                const { data: { session } } = await supabase.auth.getSession();
                return session?.user || null;
            } catch (e) {
                console.error('Auth check error:', e);
                return null;
            }
        }

        async function signInWithGoogle() {
            if (!supabase) {
                showLoginError('Supabase„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                return;
            }
            try {
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + window.location.pathname
                    }
                });
                if (error) throw error;
            } catch (e) {
                console.error('Sign in error:', e);
                showLoginError('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message);
            }
        }

        async function signOut() {
            if (!supabase) return;
            try {
                await supabase.auth.signOut();
                currentUser = null;
                updateAuthUI();
            } catch (e) {
                console.error('Sign out error:', e);
            }
        }

        function showLoginError(message) {
            const el = document.getElementById('login-error');
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function updateAuthUI() {
            const loginView = document.getElementById('view-login');
            const appView = document.getElementById('app');
            const userMenu = document.getElementById('user-menu');
            const userAvatar = document.getElementById('user-avatar');

            if (currentUser) {
                loginView.classList.add('hidden');
                appView.classList.remove('hidden');
                userMenu.classList.remove('hidden');

                // Set avatar
                const avatarUrl = currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture || '';
                if (avatarUrl) {
                    userAvatar.src = avatarUrl;
                    userAvatar.style.display = 'block';
                } else {
                    userAvatar.style.display = 'none';
                }
            } else {
                loginView.classList.remove('hidden');
                appView.classList.add('hidden');
                userMenu.classList.add('hidden');
            }
        }

        // --- Utils ---
        function getStoredRecipes() {
            try {
                return JSON.parse(localStorage.getItem(LS_KEY) || '[]');
            } catch {
                return [];
            }
        }

        function saveStoredRecipes(recipes) {
            localStorage.setItem(LS_KEY, JSON.stringify(recipes));
        }

        function getApiKey() {
            return localStorage.getItem(LS_API_KEY) || '';
        }

        function saveApiKey(key) {
            localStorage.setItem(LS_API_KEY, key);
        }

        function clearApiKey() {
            localStorage.removeItem(LS_API_KEY);
        }

        // Global click handlers for API key buttons - explicitly assign to window for onclick access
        window.handleSaveApiKey = function () {
            const key = document.getElementById('api-key-input').value.trim();
            if (!key) {
                alert('API„Ç≠„Éº„ÇíÂÅEÂäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            saveApiKey(key);
            document.getElementById('api-key-status').classList.remove('hidden');
            alert('API„Ç≠„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        };

        window.handleClearApiKey = function () {
            if (!confirm('API„Ç≠„Éº„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÅEÅE)) return;
            clearApiKey();
            document.getElementById('api-key-input').value = '';
            document.getElementById('api-key-status').classList.add('hidden');
            alert('API„Ç≠„Éº„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
        };

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function showLoading(text = 'Ëß£Êûê‰∏≠...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // --- Gemini API Client ---
        async function callGemini(prompt) {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÅEÅæ„Åõ„Çì');
            }

            const response = await fetch(`${GEMINI_API_ENDPOINT}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.4,
                        topK: 32,
                        topP: 1,
                        maxOutputTokens: 4096,
                    },
                }),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            if (data.error) {
                throw new Error(`API Error: ${data.error.message}`);
            }

            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                throw new Error('No response from API');
            }
            return text;
        }

        async function callGeminiWithImage(prompt, imageBase64, mimeType) {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÅEÅæ„Åõ„Çì');
            }

            const response = await fetch(`${GEMINI_API_ENDPOINT}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType, data: imageBase64 } }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.4,
                        topK: 32,
                        topP: 1,
                        maxOutputTokens: 4096,
                    },
                }),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            if (data.error) {
                throw new Error(`API Error: ${data.error.message}`);
            }

            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                throw new Error('No response from API');
            }
            return text;
        }

        function parseJsonFromResponse(response) {
            let jsonStr = response.trim();
            if (jsonStr.startsWith('```json')) {
                jsonStr = jsonStr.slice(7);
            } else if (jsonStr.startsWith('```')) {
                jsonStr = jsonStr.slice(3);
            }
            if (jsonStr.endsWith('```')) {
                jsonStr = jsonStr.slice(0, -3);
            }
            return JSON.parse(jsonStr.trim());
        }

        // --- Prompts ---
        const IMAGE_ANALYSIS_PROMPT = `
„Åì„ÅEÁîªÂÉè„Åã„Çâ„É¨„Ç∑„ÉîÊÉÖÂ†±„ÇíÊäΩÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE
ÁîªÂÉè„Åå„É¨„Ç∑„Éî„Å´Èñ¢ÈÄ£„Åó„Å™„ÅÅE†¥Âêà„ÅE„ÄÅÁîªÂÉè„Å´ÂÜô„Å£„Å¶„ÅÅEÇãÊñôÁêÜ„ÇíÊé®Ê∏¨„Åó„Å¶„É¨„Ç∑„Éî„ÇíÁîüÊÅE„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE

‰ª•‰∏ã„ÅEJSONÂΩ¢Âºè„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÅEÅE
{
  "name": "ÊñôÁêÜÂêÅE,
  "ingredients": [
    { "name": "ÊùêÊñôÂêÅE, "amount": "ÂàÅEáè" }
  ],
  "steps": [
    { "description": "Ë™øÁêÅEâãÈ†ÅEÅEË™¨ÊòÅE, "duration": ÁßíÊï∞ÅEà„Ç™„Éó„Ç∑„Éß„É≥„ÄÅË™øÁêÅEôÇÈñì„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅE„ÅøÅEÅE}
  ]
}

Ê≥®ÊÑè‰∫ãÈ†ÅEºÅE
- Êó•Êú¨Ë™û„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ
- ÊùêÊñô„ÅØÂÖ®„Å¶Âê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ
- Ë™øÁêÅEôÇÈñìÔºÅEurationÅEâ„ÅEÁßíÂçò‰Ωç„Åß„ÄÅEõªÂ≠ê„É¨„É≥„Ç∏„ÇÅEä†ÁÜ±ÊôÇÈñì„Åå„ÅÇ„ÇãÂ∑•Á®ã„Å´„ÅÆ„ÅøÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ
`;

        const URL_EXTRACTION_PROMPT = `
‰ª•‰∏ã„ÅEURL„Åã„Çâ„É¨„Ç∑„ÉîÊÉÖÂ†±„ÇíÊé®Ê∏¨„Åó„Å¶ÁîüÊÅE„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE
URL„Å´Âê´„Åæ„Çå„Çã„Ç≠„Éº„ÉØ„Éº„Éâ„ÇÑ‰∏ÄËà¨ÁöÅEÅ™„É¨„Ç∑„Éî„Çµ„Ç§„Éà„ÅEÊßãÈÄ†„ÇíÂèÇËÄÅEÅ´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE

URL: {url}

‰ª•‰∏ã„ÅEJSONÂΩ¢Âºè„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÅEÅE
{
  "name": "ÊñôÁêÜÂêÅE,
  "ingredients": [
    { "name": "ÊùêÊñôÂêÅE, "amount": "ÂàÅEáè" }
  ],
  "steps": [
    { "description": "Ë™øÁêÅEâãÈ†ÅEÅEË™¨ÊòÅE, "duration": ÁßíÊï∞ÅEà„Ç™„Éó„Ç∑„Éß„É≥„ÄÅË™øÁêÅEôÇÈñì„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅE„ÅøÅEÅE}
  ]
}

Ê≥®ÊÑè‰∫ãÈ†ÅEºÅE
- Êó•Êú¨Ë™û„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ
- URL„Åã„ÇâÊñôÁêÜÂêç„ÇíÊé®Ê∏¨„Åó„ÄÅ‰∏ÄËà¨ÁöÅEÅ™„É¨„Ç∑„Éî„ÇíÁîüÊÅE„Åó„Å¶„Åè„Å†„Åï„ÅÑ
- ÊùêÊñô„ÅØ5„ÄÅE0ÂÄãÁ®ãÂ∫¶Âê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ
- Ë™øÁêÅEôÇÈñìÔºÅEurationÅEâ„ÅEÁßíÂçò‰Ωç„Åß„ÄÅÂä†ÁÜ±ÊôÇÈñì„Åå„ÅÇ„ÇãÂ∑•Á®ã„Å´„ÅÆ„ÅøÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ
`;

        // --- Router ---
        function navigate() {
            const hash = window.location.hash;
            const headerTitle = document.getElementById('header-title');
            const backBtn = document.getElementById('back-btn');
            const settingsBtn = document.getElementById('settings-btn');

            // Components
            const viewList = document.getElementById('view-list');
            const viewForm = document.getElementById('view-form');
            const viewDetail = document.getElementById('view-detail');
            const viewSettings = document.getElementById('view-settings');

            // Hide all
            [viewList, viewForm, viewDetail, viewSettings].forEach(el => el.classList.remove('active'));
            backBtn.classList.add('hidden');
            settingsBtn.classList.remove('hidden');

            if (!hash || hash === '#') {
                // List View
                viewList.classList.add('active');
                headerTitle.textContent = '„É¨„Ç∑„Éî‰∏ÄË¶ß';
                renderList();
            }
            else if (hash === '#create') {
                viewForm.classList.add('active');
                headerTitle.textContent = 'Êñ∞Ë¶è„É¨„Ç∑„ÉÅE;
                backBtn.classList.remove('hidden');
                backBtn.onclick = () => window.history.back();
                settingsBtn.classList.add('hidden');
                initForm();
                updateApiKeyWarnings();
            }
            else if (hash.startsWith('#edit/')) {
                // Edit View
                const id = hash.substring(6);
                const recipes = getStoredRecipes();
                const recipe = recipes.find(r => r.id === id);
                if (recipe) {
                    viewForm.classList.add('active');
                    headerTitle.textContent = '„É¨„Ç∑„ÉîÁ∑®ÈõÅE;
                    backBtn.classList.remove('hidden');
                    backBtn.onclick = () => window.history.back();
                    settingsBtn.classList.add('hidden');
                    initForm(recipe);
                    // Switch to manual tab for editing
                    switchTab('manual');
                } else {
                    window.location.hash = '';
                }
            }
            else if (hash.startsWith('#data=')) {
                // Shared View
                viewDetail.classList.add('active');
                const data = getRecipeDataFromHash(hash);
                if (data) {
                    const recipe = Array.isArray(data) ? data[0] : data;
                    headerTitle.textContent = recipe.n || recipe.name || 'ÂÖ±Êúâ„É¨„Ç∑„ÉÅE;
                    renderDetail(recipe, true); // true = isShared
                } else {
                    alert('„É¨„Ç∑„Éî„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                backBtn.classList.remove('hidden');
                backBtn.onclick = () => window.location.hash = '';
            }
            else if (hash.startsWith('#view/')) {
                // Local Detail View
                const id = hash.substring(6);
                const recipes = getStoredRecipes();
                const recipe = recipes.find(r => r.id === id);
                if (recipe) {
                    viewDetail.classList.add('active');
                    headerTitle.textContent = recipe.name;
                    renderDetail(recipe, false);
                    backBtn.classList.remove('hidden');
                    backBtn.onclick = () => window.location.hash = '';
                } else {
                    window.location.hash = '';
                }
            }
            else if (hash === '#settings') {
                viewSettings.classList.add('active');
                headerTitle.textContent = 'Ë®≠ÂÆÅE;
                backBtn.classList.remove('hidden');
                backBtn.onclick = () => window.history.back();
                settingsBtn.classList.add('hidden');
                initSettings();
            }
        }

        function getRecipeDataFromHash(hash) {
            if (!hash.startsWith('#data=')) return null;
            try {
                const encoded = hash.substring(6);
                const base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
                const padded = base64 + "=".repeat((4 - (base64.length % 4)) % 4);
                const decoded = decodeURIComponent(atob(padded));
                return JSON.parse(decoded);
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        // --- Settings ---
        function initSettings() {
            const apiKeyInput = document.getElementById('api-key-input');
            const statusEl = document.getElementById('api-key-status');
            const savedKey = getApiKey();

            if (savedKey) {
                apiKeyInput.value = savedKey;
                statusEl.classList.remove('hidden');
            } else {
                apiKeyInput.value = '';
                statusEl.classList.add('hidden');
            }
        }

        function updateApiKeyWarnings() {
            const hasKey = !!getApiKey();
            const imageWarning = document.getElementById('image-api-warning');
            const urlWarning = document.getElementById('url-api-warning');
            const analyzeImageBtn = document.getElementById('analyze-image-btn');
            const analyzeUrlBtn = document.getElementById('analyze-url-btn');

            if (hasKey) {
                imageWarning.classList.add('hidden');
                urlWarning.classList.add('hidden');
            } else {
                imageWarning.classList.remove('hidden');
                urlWarning.classList.remove('hidden');
            }

            // Update button states based on both API key and content
            updateAnalyzeButtons();
        }

        function updateAnalyzeButtons() {
            const hasKey = !!getApiKey();
            const hasImage = !!selectedImageBase64;
            const urlInput = document.getElementById('url-input');
            const hasUrl = urlInput && urlInput.value.trim().length > 0;

            document.getElementById('analyze-image-btn').disabled = !hasKey || !hasImage;
            document.getElementById('analyze-url-btn').disabled = !hasKey || !hasUrl;
        }

        // --- Tabs ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // --- Render: List ---
        function renderList(query = '') {
            let recipes = getStoredRecipes();
            const container = document.getElementById('recipe-list-container');
            const emptyState = document.getElementById('empty-state');
            const emptyTitle = document.getElementById('empty-title');
            const emptyDesc = document.getElementById('empty-desc');

            // Filter
            if (query) {
                const q = query.toLowerCase();
                recipes = recipes.filter(r => {
                    const nameMatch = (r.name || '').toLowerCase().includes(q);
                    const ingMatch = (r.ingredients || []).some(i => (i.name || '').toLowerCase().includes(q));
                    return nameMatch || ingMatch;
                });
            }

            container.innerHTML = '';

            if (recipes.length === 0) {
                emptyState.classList.remove('hidden');
                if (query) {
                    emptyTitle.textContent = 'Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü';
                    emptyDesc.textContent = `"${query}" „Å´‰∏ÄËá¥„Åô„Çã„É¨„Ç∑„Éî„ÅE„ÅÇ„Çä„Åæ„Åõ„Çì`;
                } else {
                    emptyTitle.textContent = '„É¨„Ç∑„Éî„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    emptyDesc.innerHTML = 'Âè≥‰∏ã„ÅE„Éú„Çø„É≥„Åã„ÇâÊñ∞„Åó„ÅÑ„É¨„Ç∑„Éî„Çí‰ΩúÊÅE„Åô„Çã„Åã„ÄÅEbr>„Ç¢„Éó„É™„Åã„ÇâÂÖ±Êúâ„Åï„Çå„Åü„É¨„Ç∑„Éî„Çí‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE;
                }
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            recipes.forEach(recipe => {
                const el = document.createElement('div');
                el.className = 'recipe-card';
                el.onclick = () => window.location.hash = `#view/${recipe.id}`;

                // Calculate time
                const totalSeconds = (recipe.steps || []).reduce((acc, s) => acc + (s.duration || 0), 0);
                const timeText = totalSeconds > 0 ? `${Math.floor(totalSeconds / 60)}ÂàÅE : '- ÂàÅE;

                el.innerHTML = `
                    <div style="font-size: 32px">üç≥</div>
                    <div class="recipe-card-content">
                        <div class="recipe-card-title">${escapeHtml(recipe.name)}</div>
                        <div class="recipe-card-meta">
                            ‚è± ${timeText} ¬∑ üìù ÊùêÊñô ${recipe.ingredients?.length || 0} ¬∑ üî® Â∑•Á®ÅE${recipe.steps?.length || 0}
                        </div>
                    </div>
                    <button class="delete-btn" style="font-size:18px" onclick="event.stopPropagation(); deleteRecipe('${recipe.id}')">üóë</button>
                    <div style="color: var(--secondary)">‚Ä∫</div>
                `;
                container.appendChild(el);
            });
        }

        function deleteRecipe(id) {
            if (!confirm('„Åì„ÅE„É¨„Ç∑„Éî„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÅEÅE)) return;
            const recipes = getStoredRecipes().filter(r => r.id !== id);
            saveStoredRecipes(recipes);
            renderList();
        }

        // --- Render: Detail ---
        function renderDetail(recipe, isShared) {
            // Updated normalized props
            const ingredients = recipe.i || recipe.ingredients || [];
            const steps = recipe.s || recipe.steps || [];

            // Ingredients
            const ingList = document.getElementById('detail-ingredients');
            document.getElementById('ingredient-badge').textContent = `${ingredients.length}`;
            ingList.innerHTML = ingredients.map(ing => `
                <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border)">
                    <span>${escapeHtml(ing.n || ing.name)}</span>
                    <span style="color:var(--secondary)">${escapeHtml(ing.a || ing.amount)}</span>
                </div>
            `).join('');
            // Remove last border
            if (ingList.lastElementChild) ingList.lastElementChild.style.borderBottom = 'none';

            // Steps
            const stepsList = document.getElementById('detail-steps');
            let totalSeconds = 0;
            stepsList.innerHTML = steps.map((step, i) => {
                const duration = step.t || step.duration || 0;
                totalSeconds += duration;

                let timerHtml = '';
                if (duration > 0) {
                    const min = Math.floor(duration / 60);
                    const sec = duration % 60;
                    const timeText = sec > 0 ? `${min}ÂàÅE{sec}Áßí` : `${min}ÂàÅE;
                    timerHtml = `<button class="timer-btn">‚è± ${timeText}</button>`;
                }

                return `
                    <div style="background:var(--card); padding:16px; border-radius:12px; border:1px solid var(--border); margin-bottom:12px">
                        <div style="display:flex; gap:12px;">
                            <div style="width:24px; height:24px; background:var(--tint); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; flex-shrink:0">${i + 1}</div>
                            <div style="flex:1; line-height:1.6">${escapeHtml(step.d || step.description)}</div>
                        </div>
                        ${timerHtml}
                    </div>
                `;
            }).join('');

            // Total Time
            if (totalSeconds > 0) {
                const tMin = Math.floor(totalSeconds / 60);
                document.getElementById('cooking-time-section').classList.remove('hidden');
                document.getElementById('total-time').textContent = `Á¥ÅE{tMin}ÂàÅE;
            } else {
                document.getElementById('cooking-time-section').classList.add('hidden');
            }

            // Buttons
            const saveBtn = document.getElementById('save-shared-btn');
            const openAppBtn = document.getElementById('open-app-btn');
            const editBtn = document.getElementById('edit-local-btn'); // New

            if (isShared) {
                saveBtn.classList.remove('hidden');
                openAppBtn.classList.remove('hidden');
                if (editBtn) editBtn.classList.add('hidden');

                // Save logic
                saveBtn.onclick = () => {
                    const newRecipe = {
                        id: generateId(),
                        name: recipe.n || recipe.name || 'ÂêçÁß∞Êú™Ë®≠ÂÆÅE,
                        ingredients: ingredients.map(i => ({ name: i.n || i.name, amount: i.a || i.amount })),
                        steps: steps.map(s => ({ description: s.d || s.description, duration: s.t || s.duration || 0 })),
                        createdAt: new Date().toISOString()
                    };
                    const stored = getStoredRecipes();
                    stored.unshift(newRecipe);
                    saveStoredRecipes(stored);
                    alert('„É¨„Ç∑„Éî„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                    window.location.hash = ''; // Go to list
                };

                // Deep link
                const hash = window.location.hash;
                const encodedData = hash.substring(6);
                openAppBtn.href = `recipetimer://sync?data=${encodedData}`;

            } else {
                saveBtn.classList.add('hidden');
                openAppBtn.classList.add('hidden');
                if (editBtn) {
                    editBtn.classList.remove('hidden');
                    editBtn.onclick = () => window.location.hash = `#edit/${recipe.id}`;
                }
            }
        }

        // --- Form Logic ---
        function initForm(recipe = null) {
            editingId = recipe ? recipe.id : null;
            document.getElementById('form-name').value = recipe ? recipe.name : '';
            document.getElementById('form-ingredients').innerHTML = '';
            document.getElementById('form-steps').innerHTML = '';

            // Reset image state
            selectedImageBase64 = null;
            selectedImageMimeType = null;
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('url-input').value = '';

            if (recipe) {
                // Load Ingredients
                (recipe.ingredients || []).forEach(ing => addIngredientInput(ing.name, ing.amount));
                // Load Steps
                (recipe.steps || []).forEach(step => addStepInput(step.description, step.duration));
            } else {
                // Add initial empty fields
                addIngredientInput();
                addStepInput();
            }

            updateAnalyzeButtons();
        }

        function addIngredientInput(name = '', amount = '') {
            const container = document.getElementById('form-ingredients');
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <input type="text" class="form-input" style="flex:2" placeholder="ÊùêÊñôÂêÅE(‰æÅE Ë±öËÇâ)" value="${escapeHtml(name)}">
                <input type="text" class="form-input" style="flex:1" placeholder="ÂàÅEáè" value="${escapeHtml(amount)}">
                <button type="button" class="delete-btn" onclick="this.parentElement.remove()">üóë</button>
            `;
            container.appendChild(div);
        }

        function addStepInput(desc = '', duration = 0) {
            const min = Math.floor(duration / 60);
            const sec = duration % 60;
            const container = document.getElementById('form-steps');
            const div = document.createElement('div');
            div.className = 'list-item';
            div.style.alignItems = 'flex-start';
            div.innerHTML = `
                <div style="flex:1; display:flex; flex-direction:column; gap:8px">
                    <textarea class="form-input" rows="2" placeholder="Â∑•Á®ã„ÅEË™¨ÊòÅE>${escapeHtml(desc)}</textarea>
                    <div style="display:flex; align-items:center; gap:8px; font-size:14px">
                        ‚è± „Çø„Ç§„Éû„ÅE: <input type="number" class="form-input" style="width:80px" placeholder="ÂàÅE min="0" value="${min || ''}"> ÂàÅE
                        <input type="number" class="form-input" style="width:80px" placeholder="ÁßÅE min="0" max="59" value="${sec || ''}"> ÁßÅE
                    </div>
                </div>
                <button type="button" class="delete-btn" onclick="this.parentElement.remove()">üóë</button>
            `;
            container.appendChild(div);
        }

        function saveRecipe() {
            const name = document.getElementById('form-name').value.trim();
            if (!name) {
                alert('„É¨„Ç∑„ÉîÂêç„ÇíÂÅEÂäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // Collect Ingredients
            const ingEls = document.querySelectorAll('#form-ingredients .list-item');
            const ingredients = Array.from(ingEls).map(el => {
                const inputs = el.querySelectorAll('input');
                return {
                    name: inputs[0].value.trim(),
                    amount: inputs[1].value.trim()
                };
            }).filter(i => i.name); // Filter empty names

            // Collect Steps
            const stepEls = document.querySelectorAll('#form-steps .list-item');
            const steps = Array.from(stepEls).map(el => {
                const desc = el.querySelector('textarea').value.trim();
                const inputs = el.querySelectorAll('input[type="number"]');
                const min = parseInt(inputs[0].value) || 0;
                const sec = parseInt(inputs[1].value) || 0;

                if (!desc) return null;

                return {
                    description: desc,
                    duration: (min * 60) + sec
                };
            }).filter(s => s); // Filter empty descriptions

            if (steps.length === 0) {
                if (!confirm('Ë™øÁêÅE∑•Á®ã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åå‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÅEÅE)) return;
            }

            const stored = getStoredRecipes();

            if (editingId) {
                // Update existing
                const index = stored.findIndex(r => r.id === editingId);
                if (index !== -1) {
                    stored[index] = {
                        ...stored[index],
                        name: name,
                        ingredients: ingredients,
                        steps: steps,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // Create new
                const newRecipe = {
                    id: generateId(),
                    name: name,
                    ingredients: ingredients,
                    steps: steps,
                    createdAt: new Date().toISOString()
                };
                stored.unshift(newRecipe);
            }

            saveStoredRecipes(stored);

            window.location.hash = ''; // Return to list
        }

        // --- AI Analysis ---
        async function analyzeImage() {
            if (!selectedImageBase64 || !getApiKey()) return;

            showLoading('ÁîªÂÉè„ÇíËß£Êûê‰∏≠...');
            try {
                const response = await callGeminiWithImage(IMAGE_ANALYSIS_PROMPT, selectedImageBase64, selectedImageMimeType);
                const parsed = parseJsonFromResponse(response);
                populateFormFromAI(parsed);
                switchTab('manual');
                alert('Ëß£Êûê„ÅåÂÆå‰∫ÅEÅó„Åæ„Åó„ÅüÅEÅÊâãÂÖ•Âäõ„Çø„Éñ„ÅßÁ¢∫Ë™ç„ÅEÁ∑®ÈõÅEÅó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE);
            } catch (error) {
                console.error('Image analysis error:', error);
                alert('Ëß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function analyzeUrl() {
            const url = document.getElementById('url-input').value.trim();
            if (!url || !getApiKey()) return;

            // Validate URL
            try {
                new URL(url);
            } catch {
                alert('ÊúâÂäπ„Å™URL„ÇíÂÅEÂäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            showLoading('URL„ÇíËß£Êûê‰∏≠...');
            try {
                const prompt = URL_EXTRACTION_PROMPT.replace('{url}', url);
                const response = await callGemini(prompt);
                const parsed = parseJsonFromResponse(response);
                populateFormFromAI(parsed);
                switchTab('manual');
                alert('Âèñ„ÇäËæº„Åø„ÅåÂÆå‰∫ÅEÅó„Åæ„Åó„ÅüÅEÅÊâãÂÖ•Âäõ„Çø„Éñ„ÅßÁ¢∫Ë™ç„ÅEÁ∑®ÈõÅEÅó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE);
            } catch (error) {
                console.error('URL analysis error:', error);
                alert('Âèñ„ÇäËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function populateFormFromAI(data) {
            // Set name
            document.getElementById('form-name').value = data.name || '';

            // Clear and populate ingredients
            document.getElementById('form-ingredients').innerHTML = '';
            (data.ingredients || []).forEach(ing => {
                addIngredientInput(ing.name, ing.amount);
            });
            if ((data.ingredients || []).length === 0) {
                addIngredientInput();
            }

            // Clear and populate steps
            document.getElementById('form-steps').innerHTML = '';
            (data.steps || []).forEach(step => {
                addStepInput(step.description, step.duration || 0);
            });
            if ((data.steps || []).length === 0) {
                addStepInput();
            }
        }

        // --- Image Handling ---
        function handleImageFile(file) {
            if (!file || !file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const result = e.target.result;
                // Extract base64 data
                selectedImageBase64 = result.split(',')[1];
                selectedImageMimeType = file.type;

                // Show preview
                const preview = document.getElementById('image-preview');
                preview.src = result;
                preview.classList.remove('hidden');

                updateAnalyzeButtons();
            };
            reader.readAsDataURL(file);
        }

        // --- Event Listeners ---
        // Initialize when DOM is ready (works even if already loaded)
        function initApp() {
            // Assign button handlers FIRST so UI is responsive immediately
            document.getElementById('google-login-btn').onclick = signInWithGoogle;
            document.getElementById('logout-btn').onclick = signOut;

            // TEMPORARILY BYPASS LOGIN - Show app directly
            // TODO: Re-enable Google login when OAuth is configured
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            navigate();

            /* ORIGINAL AUTH CODE - COMMENTED OUT FOR NOW
            // Initialize Supabase
            if (initSupabase()) {
                // Check auth state (async - don't block UI)
                currentUser = await checkAuthState();
                updateAuthUI();

                // Listen for auth changes
                supabase.auth.onAuthStateChange((event, session) => {
                    currentUser = session?.user || null;
                    updateAuthUI();
                    if (currentUser) {
                        navigate();
                    }
                });
            } else {
                // Supabase not loaded, show app anyway (for development)
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            }
            */

            // Navigation
            window.addEventListener('hashchange', navigate);


            // Settings button
            document.getElementById('settings-btn').onclick = () => {
                window.location.hash = '#settings';
            };

            // FAB
            document.getElementById('fab-create').onclick = () => {
                window.location.hash = '#create';
            };

            // Search
            document.getElementById('search-input').addEventListener('input', (e) => {
                renderList(e.target.value.trim());
            });

            // Form buttons
            document.getElementById('form-save').onclick = saveRecipe;
            document.getElementById('form-cancel').onclick = () => window.history.back();

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = () => switchTab(tab.dataset.tab);
            });

            // Image upload
            const uploadArea = document.getElementById('image-upload-area');
            const imageInput = document.getElementById('image-file-input');
            const cameraInput = document.getElementById('camera-input');

            uploadArea.onclick = () => imageInput.click();

            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            };
            uploadArea.ondragleave = () => uploadArea.classList.remove('dragover');
            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                handleImageFile(file);
            };

            imageInput.onchange = (e) => handleImageFile(e.target.files[0]);
            cameraInput.onchange = (e) => handleImageFile(e.target.files[0]);

            // Analyze buttons
            document.getElementById('analyze-image-btn').onclick = analyzeImage;
            document.getElementById('analyze-url-btn').onclick = analyzeUrl;

            // URL input change
            document.getElementById('url-input').addEventListener('input', updateAnalyzeButtons);

            // Settings
            document.getElementById('save-api-key-btn').onclick = () => {
                const key = document.getElementById('api-key-input').value.trim();
                if (!key) {
                    alert('API„Ç≠„Éº„ÇíÂÅEÂäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                saveApiKey(key);
                document.getElementById('api-key-status').classList.remove('hidden');
                alert('API„Ç≠„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            };

            document.getElementById('clear-api-key-btn').onclick = () => {
                if (!confirm('API„Ç≠„Éº„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÅEÅE)) return;
                clearApiKey();
                document.getElementById('api-key-input').value = '';
                document.getElementById('api-key-status').classList.add('hidden');
                alert('API„Ç≠„Éº„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
            };
        }

        // Run initApp when DOM is ready, or immediately if already ready
        console.log('[Recipe App] Script loaded, readyState:', document.readyState);
        try {
            if (document.readyState === 'loading') {
                console.log('[Recipe App] Waiting for DOMContentLoaded...');
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('[Recipe App] DOMContentLoaded fired, calling initApp()');
                    initApp();
                });
            } else {
                console.log('[Recipe App] DOM already ready, calling initApp() immediately');
                initApp();
            }
        } catch (e) {
            console.error('[Recipe App] Error during initialization:', e);
        }

    </script>
    <!-- Fallback initializer script - runs after main script -->
    <script>
        // If main script didn't initialize, try again
        (function () {
            console.log('[Recipe App Fallback] Checking initialization...');
            const loginView = document.getElementById('view-login');
            const appView = document.getElementById('app');

            // If login view is visible and app is hidden, we need to bypass
            if (loginView && !loginView.classList.contains('hidden')) {
                console.log('[Recipe App Fallback] Bypassing login...');
                loginView.classList.add('hidden');
                if (appView) {
                    appView.classList.remove('hidden');
                }
            }

            // Wait a bit and check if initApp was called
            setTimeout(function () {
                console.log('[Recipe App Fallback] Delayed check - initApp exists:', typeof initApp);

                // If initApp exists but wasn't called, call it now
                if (typeof initApp === 'function') {
                    const fabBtn = document.getElementById('fab-create');
                    // Check if event listeners are NOT attached yet (onclick is null)
                    if (fabBtn && !fabBtn.onclick) {
                        console.log('[Recipe App Fallback] Calling initApp()...');
                        try {
                            initApp();
                        } catch (e) {
                            console.error('[Recipe App Fallback] initApp error:', e);
                        }
                    }
                } else {
                    // initApp doesn't exist - set up minimal navigation manually
                    console.log('[Recipe App Fallback] Setting up minimal navigation...');

                    // FAB button
                    const fabBtn = document.getElementById('fab-create');
                    if (fabBtn && !fabBtn.onclick) {
                        fabBtn.onclick = function () {
                            window.location.hash = '#create';
                        };
                    }

                    // Settings button
                    const settingsBtn = document.getElementById('settings-btn');
                    if (settingsBtn && !settingsBtn.onclick) {
                        settingsBtn.onclick = function () {
                            window.location.hash = '#settings';
                        };
                    }

                    // Back button
                    const backBtn = document.getElementById('back-btn');
                    if (backBtn && !backBtn.onclick) {
                        backBtn.onclick = function () {
                            window.history.back();
                        };
                    }

                    // Hash change navigation
                    if (typeof navigate === 'function') {
                        window.addEventListener('hashchange', navigate);
                        navigate();
                    } else {
                        // Minimal hash change handler
                        window.addEventListener('hashchange', function () {
                            const hash = window.location.hash;
                            const viewList = document.getElementById('view-list');
                            const viewForm = document.getElementById('view-form');
                            const viewDetail = document.getElementById('view-detail');
                            const viewSettings = document.getElementById('view-settings');
                            const headerTitle = document.getElementById('header-title');
                            const backBtn = document.getElementById('back-btn');
                            const settingsBtn = document.getElementById('settings-btn');

                            // Hide all views
                            [viewList, viewForm, viewDetail, viewSettings].forEach(function (el) {
                                if (el) el.classList.remove('active');
                            });
                            if (backBtn) backBtn.classList.add('hidden');
                            if (settingsBtn) settingsBtn.classList.remove('hidden');

                            if (!hash || hash === '#' || hash === '') {
                                if (viewList) viewList.classList.add('active');
                                if (headerTitle) headerTitle.textContent = '„É¨„Ç∑„Éî‰∏ÄË¶ß';
                            } else if (hash === '#create') {
                                if (viewForm) viewForm.classList.add('active');
                                if (headerTitle) headerTitle.textContent = 'Êñ∞Ë¶è„É¨„Ç∑„ÉÅE;
                                if (backBtn) backBtn.classList.remove('hidden');
                                if (settingsBtn) settingsBtn.classList.add('hidden');
                            } else if (hash === '#settings') {
                                if (viewSettings) viewSettings.classList.add('active');
                                if (headerTitle) headerTitle.textContent = 'Ë®≠ÂÆÅE;
                                if (backBtn) backBtn.classList.remove('hidden');
                                if (settingsBtn) settingsBtn.classList.add('hidden');
                            }
                        });

                        // Navigate to current hash or list view
                        const viewList = document.getElementById('view-list');
                        if (viewList && !window.location.hash) {
                            viewList.classList.add('active');
                        }
                    }
                }
            }, 100);
        })();
    </script>
    <!-- Early Global Handlers - Must be first -->
    <script>
        window.handleSaveApiKey = function() {
            var key = document.getElementById('api-key-input').value.trim();
            if (!key) { alert('APIÉLÅ[Çì¸óÕÇµÇƒÇ≠ÇæÇ≥Ç¢'); return; }
            localStorage.setItem('recipeTimer_geminiApiKey', key);
            var statusEl = document.getElementById('api-key-status');
            if (statusEl) statusEl.classList.remove('hidden');
            alert('APIÉLÅ[Çï€ë∂ÇµÇ‹ÇµÇΩ');
        };
        window.handleClearApiKey = function() {
            if (!confirm('APIÉLÅ[ÇÉNÉäÉAÇµÇ‹Ç∑Ç©ÅH')) return;
            localStorage.removeItem('recipeTimer_geminiApiKey');
            var inputEl = document.getElementById('api-key-input');
            var statusEl = document.getElementById('api-key-status');
            if (inputEl) inputEl.value = '';
            if (statusEl) statusEl.classList.add('hidden');
            alert('APIÉLÅ[ÇÉNÉäÉAÇµÇ‹ÇµÇΩ');
        };
        console.log('[Early] Global handlers defined');
    </script>
</body>

</html>